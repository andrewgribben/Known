"use strict";function Unfurl(){}Unfurl.fetch=function(a,b){if(a.length>0){Security.getCSRFToken(function(c,d){$.getJSON(known.config.displayUrl+"service/web/unfurl/",{url:a,__bTk:c,__bTs:d},function(e){b(e)})},known.config.displayUrl+"service/web/unfurl/")}};Unfurl.getUrls=function(b){console.log(b);var a=new RegExp("(https?://[^\\s]+)","gi");return b.match(a)};Unfurl.getFirstUrl=function(b){var a=Unfurl.getUrls(b);console.log(a);if((a!=undefined)&&(a.length>0)){return a[0]}return""};Unfurl.initOembed=function(d){var a=d.find("div.oembed");if(a!=undefined){var b=a.attr("data-url");var c=a.attr("data-format");if(b!=undefined){console.log("Fetching oembed code from "+b+" using "+c);$.ajax({url:b,dataType:c,success:function(g){console.log("Got a response back");if(c=="xml"){console.log("XML Format");var f=$(g);var e=f.find("html").text();if(e.indexOf("CDATA")>-1){e=e.substr(9,e.length-12)}a.html(e)}else{console.log("JSON Format");a.html(g.html)}a.closest(".unfurled-url").find(".basics").hide()}})}}};Unfurl.enableControls=function(e){var b=e.attr("data-url");var d=e.closest(".unfurl-block");var c=d.find(".unfurl-edit a.refresh");var a=d.find(".unfurl-edit a.delete");c.click(function(f){Security.getCSRFToken(function(g,h){$.ajax(known.config.displayUrl+"service/web/unfurl/",{dataType:"json",method:"GET",data:{url:b,forcenew:true,__bTk:g,__bTs:h},success:function(i){console.log("Refreshed");e.fadeOut().fadeIn();Unfurl.unfurl(e)}})},known.config.displayUrl+"service/web/unfurl/");f.preventDefault()});a.click(function(f){Security.getCSRFToken(function(g,h){$.ajax(known.config.displayUrl+"service/web/unfurl/remove/"+d.attr("data-parent-object")+"/",{dataType:"json",method:"POST",data:{__bTk:g,__bTs:h},success:function(i){console.log("Refresh: deleted");d.fadeOut()}})},known.config.displayUrl+"service/web/unfurl/remove/"+d.attr("data-parent-object")+"/");f.preventDefault()})};Unfurl.unfurl=function(b){var a=b.attr("data-url");if(a!=undefined){Unfurl.fetch(a,function(c){b.html(c.rendered);b.show();Unfurl.initOembed(b);Template.enableImageFallback();Unfurl.enableControls(b)})}};Unfurl.unfurlAll=function(){$("div.unfurl").each(function(){Unfurl.unfurl($(this))})};$(document).ready(function(){Unfurl.unfurlAll()});